@page "/crm"
@using PropertyHub.Application.Services
@inject CRMClientService CRMService
@inject ISnackbar Snackbar

<PageTitle>CRM & Lead Management - PropertyHub Global</PageTitle>

<div class="container-fluid mt-4">
    <h4 class="mb-4">
        <i class="bi bi-people-fill me-2"></i> CRM & Lead Management
    </h4>

    @* View Toggle *@
    <div class="card mb-4">
        <div class="card-body">
            <div class="btn-group me-2">
                <button type="button" class="btn @(_viewMode == "pipeline" ? "btn-primary" : "btn-outline-primary")" @onclick="@(() => _viewMode = "pipeline")">
                    <i class="bi bi-view-columns me-1"></i> Pipeline View
                </button>
                <button type="button" class="btn @(_viewMode == "list" ? "btn-primary" : "btn-outline-primary")" @onclick="@(() => _viewMode = "list")">
                    <i class="bi bi-list me-1"></i> List View
                </button>
            </div>
            <button type="button" class="btn btn-success float-end" @onclick="OpenCreateDialog">
                <i class="bi bi-plus-circle me-1"></i> Add Lead
            </button>
        </div>
    </div>

    @* Pipeline Statistics *@
    @if (_pipelineStats != null)
    {
        <div class="row mb-4">
            <div class="col-12 col-sm-4 col-md-2 mb-3">
                <div class="card text-center">
                    <div class="card-body p-3">
                        <h6 class="text-muted mb-1">Total Leads</h6>
                        <h5>@_pipelineStats.TotalLeads</h5>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-4 col-md-2 mb-3">
                <div class="card text-center">
                    <div class="card-body p-3">
                        <h6 class="text-muted mb-1">Avg Score</h6>
                        <h5 class="@GetScoreColorClass(_pipelineStats.AverageScore)">@_pipelineStats.AverageScore</h5>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-4 col-md-2 mb-3">
                <div class="card text-center">
                    <div class="card-body p-3">
                        <h6 class="text-muted mb-1">Converted</h6>
                        <h5 class="text-success">@_pipelineStats.ConvertedLeads</h5>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-4 col-md-2 mb-3">
                <div class="card text-center">
                    <div class="card-body p-3">
                        <h6 class="text-muted mb-1">Lost</h6>
                        <h5 class="text-danger">@_pipelineStats.LostLeads</h5>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-4 col-md-2 mb-3">
                <div class="card text-center">
                    <div class="card-body p-3">
                        <h6 class="text-muted mb-1">Conv. Rate</h6>
                        <h5 class="text-info">@_pipelineStats.ConversionRate.ToString("N1")%</h5>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-4 col-md-2 mb-3">
                <div class="card text-center">
                    <div class="card-body p-3">
                        <h6 class="text-muted mb-1">New Today</h6>
                        <h5>@_pipelineStats.NewLeads</h5>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Loading State *@
    @if (_loading)
    {
        <div class="progress mb-4">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
        </div>
    }

    @* Pipeline View *@
    @if (_viewMode == "pipeline" && _pipelineStats != null)
    {
        <div class="row">
            @* New *@
            <div class="col-12 col-md-2 mb-3">
                <div class="card" style="min-height: 400px;">
                    <div class="card-body p-3">
                        <h6 class="mb-2">
                            <span class="badge bg-secondary me-1">@_pipelineStats.NewLeads</span> New
                        </h6>
                        <hr class="mb-2" />
                        <div class="d-flex flex-column gap-2">
                            @foreach (var lead in GetLeadsByStatus("New"))
                            {
                                <div class="card" style="cursor: pointer;" @onclick="@(() => OpenLeadDetails(lead.Id))">
                                    <div class="card-body p-2">
                                        <div class="fw-bold">@lead.FullName</div>
                                        <div class="small text-muted">@lead.BuyerType</div>
                                        <span class="badge @GetScoreColorClass(lead.Score)">Score: @lead.Score</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            @* Contacted *@
            <div class="col-12 col-md-2 mb-3">
                <div class="card" style="min-height: 400px;">
                    <div class="card-body p-3">
                        <h6 class="mb-2">
                            <span class="badge bg-primary me-1">@_pipelineStats.ContactedLeads</span> Contacted
                        </h6>
                        <hr class="mb-2" />
                        <div class="d-flex flex-column gap-2">
                            @foreach (var lead in GetLeadsByStatus("Contacted"))
                            {
                                <div class="card" style="cursor: pointer;" @onclick="@(() => OpenLeadDetails(lead.Id))">
                                    <div class="card-body p-2">
                                        <div class="fw-bold">@lead.FullName</div>
                                        <div class="small text-muted">@lead.BuyerType</div>
                                        <span class="badge @GetScoreColorClass(lead.Score)">Score: @lead.Score</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            @* Qualified *@
            <div class="col-12 col-md-2 mb-3">
                <div class="card" style="min-height: 400px;">
                    <div class="card-body p-3">
                        <h6 class="mb-2">
                            <span class="badge bg-info me-1">@_pipelineStats.QualifiedLeads</span> Qualified
                        </h6>
                        <hr class="mb-2" />
                        <div class="d-flex flex-column gap-2">
                            @foreach (var lead in GetLeadsByStatus("Qualified"))
                            {
                                <div class="card" style="cursor: pointer;" @onclick="@(() => OpenLeadDetails(lead.Id))">
                                    <div class="card-body p-2">
                                        <div class="fw-bold">@lead.FullName</div>
                                        <div class="small text-muted">@lead.BuyerType</div>
                                        <span class="badge @GetScoreColorClass(lead.Score)">Score: @lead.Score</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            @* Viewing *@
            <div class="col-12 col-md-2 mb-3">
                <div class="card" style="min-height: 400px;">
                    <div class="card-body p-3">
                        <h6 class="mb-2">
                            <span class="badge bg-warning me-1">@_pipelineStats.ViewingLeads</span> Viewing
                        </h6>
                        <hr class="mb-2" />
                        <div class="d-flex flex-column gap-2">
                            @foreach (var lead in GetLeadsByStatus("Viewing"))
                            {
                                <div class="card" style="cursor: pointer;" @onclick="@(() => OpenLeadDetails(lead.Id))">
                                    <div class="card-body p-2">
                                        <div class="fw-bold">@lead.FullName</div>
                                        <div class="small text-muted">@lead.BuyerType</div>
                                        <span class="badge @GetScoreColorClass(lead.Score)">Score: @lead.Score</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            @* Negotiating *@
            <div class="col-12 col-md-2 mb-3">
                <div class="card" style="min-height: 400px;">
                    <div class="card-body p-3">
                        <h6 class="mb-2">
                            <span class="badge bg-secondary me-1">@_pipelineStats.NegotiatingLeads</span> Negotiating
                        </h6>
                        <hr class="mb-2" />
                        <div class="d-flex flex-column gap-2">
                            @foreach (var lead in GetLeadsByStatus("Negotiating"))
                            {
                                <div class="card" style="cursor: pointer;" @onclick="@(() => OpenLeadDetails(lead.Id))">
                                    <div class="card-body p-2">
                                        <div class="fw-bold">@lead.FullName</div>
                                        <div class="small text-muted">@lead.BuyerType</div>
                                        <span class="badge @GetScoreColorClass(lead.Score)">Score: @lead.Score</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            @* Converted *@
            <div class="col-12 col-md-2 mb-3">
                <div class="card" style="min-height: 400px;">
                    <div class="card-body p-3">
                        <h6 class="mb-2">
                            <span class="badge bg-success me-1">@_pipelineStats.ConvertedLeads</span> Converted
                        </h6>
                        <hr class="mb-2" />
                        <div class="d-flex flex-column gap-2">
                            @foreach (var lead in GetLeadsByStatus("Converted"))
                            {
                                <div class="card" style="cursor: pointer;" @onclick="@(() => OpenLeadDetails(lead.Id))">
                                    <div class="card-body p-2">
                                        <div class="fw-bold">@lead.FullName</div>
                                        <div class="small text-muted">@lead.BuyerType</div>
                                        <span class="badge @GetScoreColorClass(lead.Score)">Score: @lead.Score</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    @* List View *@
    @if (_viewMode == "list" && _leads != null && _leads.Any())
    {
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-12 col-md-3 mb-3">
                        <label class="form-label">Search Leads</label>
                        <div class="input-group">
                            <input type="text" class="form-control" @bind="_searchTerm" @onkeyup="@(async (e) => { if (e.Key == "Enter") await LoadLeadsAsync(); })" placeholder="Search..." />
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                        </div>
                    </div>
                    <div class="col-12 col-md-2 mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" @bind="_selectedStatus">
                            <option value="">All Statuses</option>
                            <option value="New">New</option>
                            <option value="Contacted">Contacted</option>
                            <option value="Qualified">Qualified</option>
                            <option value="Viewing">Viewing</option>
                            <option value="Negotiating">Negotiating</option>
                            <option value="Converted">Converted</option>
                            <option value="Lost">Lost</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-2 mb-3">
                        <label class="form-label">Buyer Type</label>
                        <select class="form-select" @bind="_selectedBuyerType">
                            <option value="">All Types</option>
                            <option value="HNI">HNI</option>
                            <option value="Investor">Investor</option>
                            <option value="Retail">Retail</option>
                            <option value="Commercial">Commercial</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-2 mb-3">
                        <label class="form-label">Sort By</label>
                        <select class="form-select" @bind="_selectedSortBy">
                            <option value="latest">Latest First</option>
                            <option value="score_desc">Score: High to Low</option>
                            <option value="score_asc">Score: Low to High</option>
                            <option value="budget_desc">Budget: High to Low</option>
                            <option value="name_asc">Name: A-Z</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-3 mb-3 d-flex align-items-end">
                        <button type="button" class="btn btn-primary w-100" @onclick="LoadLeadsAsync">
                            <i class="bi bi-funnel me-1"></i> Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Lead</th>
                        <th>Contact</th>
                        <th>Buyer Type</th>
                        <th>Budget</th>
                        <th>Timeline</th>
                        <th>Status</th>
                        <th>Score</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var lead in _leads)
                    {
                        <tr @onclick="@(() => OpenLeadDetails(lead.Id))" style="cursor: pointer;">
                            <td>
                                <div class="fw-bold">@lead.FullName</div>
                                <div class="small text-muted">@lead.Source</div>
                            </td>
                            <td>
                                <div class="small">@lead.Email</div>
                                <div class="small text-muted">@lead.Phone</div>
                            </td>
                            <td>
                                <span class="badge @GetBuyerTypeColorClass(lead.BuyerType)">@lead.BuyerType</span>
                            </td>
                            <td>
                                <div class="small">@lead.Currency @lead.BudgetMin?.ToString("N0") - @lead.BudgetMax?.ToString("N0")</div>
                            </td>
                            <td>@lead.Timeline</td>
                            <td>
                                <span class="badge @GetStatusColorClass(lead.Status)">@lead.Status</span>
                            </td>
                            <td>
                                <span class="badge @GetScoreColorClass(lead.Score)">@lead.Score</span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary" @onclick="@(() => OpenLeadDetails(lead.Id))" @onclick:stopPropagation>
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" @onclick:stopPropagation>
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-center mt-4">
            <nav aria-label="Table pagination">
                <ul class="pagination">
                    @if (_currentPage > 1)
                    {
                        <li class="page-item">
                            <button class="page-link" @onclick="@(() => OnPageChanged(_currentPage - 1))">Previous</button>
                        </li>
                    }
                    
                    @for (int i = Math.Max(1, _currentPage - 2); i <= Math.Min(_totalPages, _currentPage + 2); i++)
                    {
                        <li class="page-item @(i == _currentPage ? "active" : "")">
                            <button class="page-link" @onclick="@(() => OnPageChanged(i))">@i</button>
                        </li>
                    }
                    
                    @if (_currentPage < _totalPages)
                    {
                        <li class="page-item">
                            <button class="page-link" @onclick="@(() => OnPageChanged(_currentPage + 1))">Next</button>
                        </li>
                    }
                </ul>
            </nav>
        </div>
    }

    @if (_viewMode == "list" && (_leads == null || !_leads.Any()) && !_loading)
    {
        <div class="card text-center p-5">
            <div class="card-body">
                <i class="bi bi-search display-4 text-muted"></i>
                <h5 class="text-muted mt-3">No leads found</h5>
                <p class="text-muted">Try adjusting your filters or add a new lead</p>
            </div>
        </div>
    }
</div>

@* Lead Details Modal *@
@if (_showDetailsDialog && _selectedLead != null)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Lead Details</h5>
                    <button type="button" class="btn-close" @onclick="@(() => _showDetailsDialog = false)"></button>
                </div>
                <div class="modal-body">
                    <p>Lead ID: @_selectedLead.Id</p>
                    <p>Lead details coming soon...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="@(() => _showDetailsDialog = false)">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    // State
    private bool _loading = true;
    private string _viewMode = "pipeline";
    private List<LeadDto>? _leads;
    private LeadDetailDto? _selectedLead;
    private PipelineStatsDto? _pipelineStats;
    private Dictionary<string, List<LeadDto>> _pipelineLeads = new();
    
    // UI State
    private bool _showDetailsDialog = false;
    private string? _searchTerm;
    private string? _selectedStatus;
    private string? _selectedBuyerType;
    private string _selectedSortBy = "score_desc";
    private int _currentPage = 1;
    private int _totalPages;
    private int _pageSize = 50;

    protected override async Task OnInitializedAsync()
    {
        await LoadPipelineDataAsync();
        await LoadLeadsAsync();
    }

    private async Task LoadPipelineDataAsync()
    {
        _pipelineStats = await CRMService.GetPipelineStatsAsync();
        
        // Load leads for each status
        var statuses = new[] { "New", "Contacted", "Qualified", "Viewing", "Negotiating", "Converted", "Lost" };
        foreach (var status in statuses)
        {
            var leads = await CRMService.GetLeadsByStatusAsync(status);
            _pipelineLeads[status] = leads ?? new List<LeadDto>();
        }
        
        StateHasChanged();
    }

    private async Task LoadLeadsAsync()
    {
        _loading = true;
        StateHasChanged();

        var filters = new LeadFilterOptions
        {
            SearchTerm = _searchTerm,
            Status = _selectedStatus,
            BuyerType = _selectedBuyerType,
            SortBy = _selectedSortBy,
            Limit = _pageSize,
            Offset = (_currentPage - 1) * _pageSize
        };

        var result = await CRMService.GetLeadsAsync(filters);
        
        if (result != null)
        {
            _leads = result.Leads;
            _totalPages = (int)Math.Ceiling((double)result.Total / _pageSize);
        }
        else
        {
            await Snackbar.Add("Error loading leads", Severity.Error);
        }

        _loading = false;
        StateHasChanged();
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page;
        await LoadLeadsAsync();
    }

    private List<LeadDto> GetLeadsByStatus(string status)
    {
        return _pipelineLeads.ContainsKey(status) ? _pipelineLeads[status] : new List<LeadDto>();
    }

    private async void OpenLeadDetails(Guid leadId)
    {
        var lead = await CRMService.GetLeadByIdAsync(leadId);
        if (lead != null)
        {
            _selectedLead = lead;
            _showDetailsDialog = true;
            StateHasChanged();
        }
        else
        {
            await Snackbar.Add("Error loading lead details", Severity.Error);
        }
    }

    private void OpenCreateDialog()
    {
        Snackbar.Add("Create lead feature coming soon!", Severity.Info);
    }

    private string GetScoreColorClass(int score)
    {
        return score >= 80 ? "bg-success text-white" : score >= 60 ? "bg-warning text-dark" : "bg-danger text-white";
    }

    private string GetStatusColorClass(string status)
    {
        return status switch
        {
            "New" => "bg-secondary",
            "Contacted" => "bg-primary",
            "Qualified" => "bg-info",
            "Viewing" => "bg-warning text-dark",
            "Negotiating" => "bg-secondary",
            "Converted" => "bg-success",
            "Lost" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private string GetBuyerTypeColorClass(string buyerType)
    {
        return buyerType switch
        {
            "HNI" => "bg-success",
            "Investor" => "bg-info",
            "Retail" => "bg-primary",
            "Commercial" => "bg-secondary",
            _ => "bg-secondary"
        };
    }
}
