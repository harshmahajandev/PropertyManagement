@page "/customer/register"
@using PropertyHub.Application.DTOs
@using PropertyHub.Core.Enums
@inject HttpClient Http
@inject NavigationManager Navigation
@* Snackbar is removed, we'll use Bootstrap alerts instead *@

<PageTitle>Customer Registration - PropertyHub Global</PageTitle>

<div class="container mt-4">
    <div class="card shadow-sm p-4">
        <h4 class="text-center mb-3">
            <i class="fas fa-user-plus me-2"></i>
            Quick Registration
        </h4>
        <p class="text-center text-muted mb-4">Join PropertyHub Global in just 60 seconds</p>

        <!-- Stepper Progress Bar -->
        <div class="mb-4">
            <div class="progress" style="height: 8px;">
                <div class="progress-bar @(_currentStep == 0 ? "bg-primary" : _currentStep > 0 ? "bg-primary" : "bg-secondary")" 
                     role="progressbar" style="width: 25%"></div>
                <div class="progress-bar @(_currentStep == 1 ? "bg-primary" : _currentStep > 1 ? "bg-primary" : "bg-secondary")" 
                     role="progressbar" style="width: 25%"></div>
                <div class="progress-bar @(_currentStep == 2 ? "bg-primary" : _currentStep > 2 ? "bg-primary" : "bg-secondary")" 
                     role="progressbar" style="width: 25%"></div>
                <div class="progress-bar @(_currentStep == 3 ? "bg-primary" : _currentStep > 3 ? "bg-primary" : "bg-secondary")" 
                     role="progressbar" style="width: 25%"></div>
            </div>
        </div>

        <!-- Step Navigation -->
        <ul class="nav nav-pills nav-fill mb-4">
            <li class="nav-item">
                <button class="nav-link @(_currentStep == 0 ? "active" : "")" @onclick="() => GoToStep(0)">
                    <i class="fas fa-user me-1"></i> Personal Info
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(_currentStep == 1 ? "active" : "")" @onclick="() => GoToStep(1)">
                    <i class="fas fa-home me-1"></i> Preferences
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(_currentStep == 2 ? "active" : "")" @onclick="() => GoToStep(2)">
                    <i class="fas fa-calendar me-1"></i> Timeline
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(_currentStep == 3 ? "active" : "")" @onclick="() => GoToStep(3)">
                    <i class="fas fa-check-circle me-1"></i> Complete
                </button>
            </li>
        </ul>

        <!-- Bootstrap Alert for notifications -->
        @if (!string.IsNullOrEmpty(_alertMessage))
        {
            <div class="alert @_alertClass alert-dismissible fade show" role="alert">
                @_alertMessage
                <button type="button" class="btn-close" @onclick="ClearAlert"></button>
            </div>
        }

        <form>
            @* Step 1: Personal Information *@
            @if (_currentStep == 0)
            {
                <div class="step-content">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="fullName" class="form-label">Full Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="fullName" @bind="_registration.FullName" required />
                            <div class="form-text">Enter your full name</div>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="email" class="form-label">Email Address <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" @bind="_registration.Email" required />
                            <div class="form-text">We'll send updates to this email</div>
                        </div>
                        <div class="col-12 col-md-6 mb-3">
                            <label for="phone" class="form-label">Phone Number <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="phone" @bind="_registration.Phone" required />
                            <div class="form-text">Include country code</div>
                        </div>
                        <div class="col-12 col-md-6 mb-3">
                            <label for="nationality" class="form-label">Nationality</label>
                            <input type="text" class="form-control" id="nationality" @bind="_registration.Nationality" />
                            <div class="form-text">Optional</div>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="company" class="form-label">Company</label>
                            <input type="text" class="form-control" id="company" @bind="_registration.Company" />
                            <div class="form-text">If registering as a business</div>
                        </div>
                    </div>
                </div>
            }

            @* Step 2: Property Preferences *@
            @if (_currentStep == 1)
            {
                <div class="step-content">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label">What type of property are you looking for?</label>
                            <div class="btn-group" role="group">
                                @foreach (var propertyType in _availablePropertyTypes)
                                {
                                    <input type="checkbox" class="btn-check" id="prop-@propertyType" 
                                           @onchange="(e) => TogglePropertyType(propertyType, e)" checked="@_registration.PropertyTypes?.Contains(propertyType) == true" />
                                    <label class="btn btn-outline-primary" for="prop-@propertyType">@propertyType</label>
                                }
                            </div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label class="form-label">Preferred Locations</label>
                            <div class="btn-group" role="group" style="flex-wrap: wrap;">
                                @foreach (var location in _availableLocations)
                                {
                                    <input type="checkbox" class="btn-check" id="loc-@location.Replace(" ", "-")" 
                                           @onchange="(e) => ToggleLocation(location, e)" checked="@_registration.Locations?.Contains(location) == true" />
                                    <label class="btn btn-outline-secondary m-1" for="loc-@location.Replace(" ", "-")">@location</label>
                                }
                            </div>
                        </div>

                        <div class="col-12 col-md-6 mb-3">
                            <label for="budgetMin" class="form-label">Budget Min (BHD)</label>
                            <input type="number" class="form-control" id="budgetMin" @bind="_registration.BudgetMin" min="0" />
                        </div>
                        <div class="col-12 col-md-6 mb-3">
                            <label for="budgetMax" class="form-label">Budget Max (BHD)</label>
                            <input type="number" class="form-control" id="budgetMax" @bind="_registration.BudgetMax" min="0" />
                        </div>

                        <div class="col-12 col-md-6 mb-3">
                            <label for="bedrooms" class="form-label">Minimum Bedrooms</label>
                            <input type="number" class="form-control" id="bedrooms" @bind="_registration.Bedrooms" min="0" max="10" />
                        </div>
                        <div class="col-12 col-md-6 mb-3">
                            <label for="bathrooms" class="form-label">Minimum Bathrooms</label>
                            <input type="number" class="form-control" id="bathrooms" @bind="_registration.Bathrooms" min="0" max="10" />
                        </div>
                    </div>
                </div>
            }

            @* Step 3: Timeline & Requirements *@
            @if (_currentStep == 2)
            {
                <div class="step-content">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label">When are you planning to buy?</label>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="timeline" id="timeline-immediate" 
                                       value="Immediate" @onchange="() => _registration.Timeline = Timeline.Immediate" checked="@(_registration.Timeline == Timeline.Immediate)" />
                                <label class="form-check-label" for="timeline-immediate">
                                    <strong>Immediate</strong> - Ready to buy now
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="timeline" id="timeline-1-3" 
                                       value="OneToThreeMonths" @onchange="() => _registration.Timeline = Timeline.OneToThreeMonths" checked="@(_registration.Timeline == Timeline.OneToThreeMonths)" />
                                <label class="form-check-label" for="timeline-1-3">
                                    <strong>1-3 Months</strong> - Within a quarter
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="timeline" id="timeline-3-6" 
                                       value="ThreeToSixMonths" @onchange="() => _registration.Timeline = Timeline.ThreeToSixMonths" checked="@(_registration.Timeline == Timeline.ThreeToSixMonths)" />
                                <label class="form-check-label" for="timeline-3-6">
                                    <strong>3-6 Months</strong> - This year
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="timeline" id="timeline-6-12" 
                                       value="SixToTwelveMonths" @onchange="() => _registration.Timeline = Timeline.SixToTwelveMonths" checked="@(_registration.Timeline == Timeline.SixToTwelveMonths)" />
                                <label class="form-check-label" for="timeline-6-12">
                                    <strong>6-12 Months</strong> - Next year
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="timeline" id="timeline-flexible" 
                                       value="Flexible" @onchange="() => _registration.Timeline = Timeline.Flexible" checked="@(_registration.Timeline == Timeline.Flexible)" />
                                <label class="form-check-label" for="timeline-flexible">
                                    <strong>Flexible</strong> - Just exploring options
                                </label>
                            </div>
                        </div>

                        <div class="col-12 mb-3">
                            <label for="requirements" class="form-label">Any Special Requirements?</label>
                            <textarea class="form-control" id="requirements" rows="5" @bind="_registration.CustomerRequirements"></textarea>
                            <div class="form-text">Tell us about your specific needs or preferences</div>
                        </div>
                    </div>
                </div>
            }

            @* Step 4: Confirmation *@
            @if (_currentStep == 3)
            {
                <div class="step-content">
                    <div class="alert alert-success" role="alert">
                        <h5 class="alert-heading">You're all set!</h5>
                        <p>Review your information and click Register to complete.</p>
                    </div>

                    <div class="border rounded p-3">
                        <h6>Your Information</h6>
                        <hr class="mb-3" />
                        
                        <p><strong>Name:</strong> @_registration.FullName</p>
                        <p><strong>Email:</strong> @_registration.Email</p>
                        <p><strong>Phone:</strong> @_registration.Phone</p>
                        
                        @if (!string.IsNullOrEmpty(_registration.Nationality))
                        {
                            <p><strong>Nationality:</strong> @_registration.Nationality</p>
                        }
                        
                        @if (_registration.PropertyTypes?.Any() == true)
                        {
                            <p class="mt-3"><strong>Property Types:</strong> @string.Join(", ", _registration.PropertyTypes)</p>
                        }
                        
                        @if (_registration.Locations?.Any() == true)
                        {
                            <p><strong>Locations:</strong> @string.Join(", ", _registration.Locations)</p>
                        }
                        
                        @if (_registration.BudgetMin.HasValue || _registration.BudgetMax.HasValue)
                        {
                            <p><strong>Budget:</strong> @(_registration.BudgetMin?.ToString("N0") ?? "0") - @(_registration.BudgetMax?.ToString("N0") ?? "âˆž") BHD</p>
                        }
                        
                        <p><strong>Timeline:</strong> @_registration.Timeline</p>
                    </div>
                </div>
            }

            <hr class="my-4" />

            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary" 
                        disabled="@(_currentStep == 0)" @onclick="PreviousStep">
                    <i class="fas fa-chevron-left me-1"></i> Back
                </button>

                @if (_currentStep < 3)
                {
                    <button type="button" class="btn btn-primary" @onclick="NextStep">
                        Next <i class="fas fa-chevron-right ms-1"></i>
                    </button>
                }
                else
                {
                    <button type="button" class="btn btn-success" 
                            disabled="@_isRegistering" @onclick="RegisterAsync">
                        @if (_isRegistering)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>Registering...</span>
                        }
                        else
                        {
                            <i class="fas fa-check-circle me-2"></i>
                            <span>Register</span>
                        }
                    </button>
                }
            </div>

            <p class="text-center text-muted mt-4">
                Already have an account? 
                <a href="/customer/login" class="text-decoration-none">Login here</a>
            </p>
        </form>
    </div>
</div>

@code {
    private CustomerRegistrationDto _registration = new();
    private bool _isRegistering = false;
    private int _currentStep = 0;
    private string _alertMessage = string.Empty;
    private string _alertClass = "alert-success";

    // Available options for property types and locations
    private readonly List<string> _availablePropertyTypes = new()
    {
        "Villa", "Commercial", "Plot", "Investment", "Apartment"
    };

    private readonly List<string> _availableLocations = new()
    {
        "Al Bareh", "Suhail", "Jeewan", "Qalali Island", "Reemiyat Island"
    };

    private void GoToStep(int step)
    {
        if (step >= 0 && step <= 3)
        {
            _currentStep = step;
        }
    }

    private void NextStep()
    {
        if (_currentStep < 3)
        {
            _currentStep++;
        }
    }

    private void PreviousStep()
    {
        if (_currentStep > 0)
        {
            _currentStep--;
        }
    }

    private void TogglePropertyType(string propertyType, ChangeEventArgs e)
    {
        if (_registration.PropertyTypes == null)
            _registration.PropertyTypes = new List<string>();

        if (e.Value as bool? == true)
        {
            if (!_registration.PropertyTypes.Contains(propertyType))
                _registration.PropertyTypes.Add(propertyType);
        }
        else
        {
            _registration.PropertyTypes.Remove(propertyType);
        }
    }

    private void ToggleLocation(string location, ChangeEventArgs e)
    {
        if (_registration.Locations == null)
            _registration.Locations = new List<string>();

        if (e.Value as bool? == true)
        {
            if (!_registration.Locations.Contains(location))
                _registration.Locations.Add(location);
        }
        else
        {
            _registration.Locations.Remove(location);
        }
    }

    private void ShowAlert(string message, string type = "success")
    {
        _alertMessage = message;
        _alertClass = type switch
        {
            "error" => "alert-danger",
            "warning" => "alert-warning",
            "info" => "alert-info",
            _ => "alert-success"
        };
    }

    private void ClearAlert()
    {
        _alertMessage = string.Empty;
    }

    private async Task RegisterAsync()
    {
        try
        {
            _isRegistering = true;
            ClearAlert();

            var response = await Http.PostAsJsonAsync("/api/CustomerPortal/register", _registration);

            if (response.IsSuccessStatusCode)
            {
                var profile = await response.Content.ReadFromJsonAsync<CustomerProfileDto>();
                ShowAlert("Registration successful! Welcome to PropertyHub Global!", "success");
                
                // Navigate to customer dashboard after a short delay
                await Task.Delay(1500);
                Navigation.NavigateTo($"/customer/dashboard/{profile!.Id}");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                ShowAlert($"Registration failed: {error}", "error");
            }
        }
        catch (Exception ex)
        {
            ShowAlert($"Error: {ex.Message}", "error");
        }
        finally
        {
            _isRegistering = false;
        }
    }
}
